<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Agile Copilot — Standup Summarizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#ffffff; --fg:#111827; --muted:#6b7280; --card:#f6f8fa; --ok:#065f46; --bad:#7f1d1d; }
    * { box-sizing: border-box; }
    body { margin: 24px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--fg); background: var(--bg); }
    h1 { margin: 0 0 8px; font-size: 22px; }
    .subtitle { color: var(--muted); margin-bottom: 18px; }
    .row { display: flex; gap: 12px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
    label { font-size: 14px; color: var(--muted); }
    input[type="date"], input[type="text"] { padding: 8px; border: 1px solid #ddd; border-radius: 8px; }
    textarea { width: 100%; height: 200px; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    button { padding: 9px 14px; border-radius: 10px; border: 1px solid #e5e7eb; background: #fff; cursor: pointer; }
    button.primary { background: #111827; color: #fff; border-color: #111827; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .bar { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0 16px; }
    .card { background: var(--card); border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; }
    pre { white-space: pre-wrap; margin: 0; }
    .status { font-size: 13px; }
    .status.ok { color: var(--ok); }
    .status.bad { color: var(--bad); }
    .muted { color: var(--muted); font-size: 13px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <h1>Agile Copilot — Standup Summarizer</h1>
  <div class="subtitle">Uses <span class="mono">/api/ai/standup</span> on your local server.</div>

  <div class="row">
    <label>API Base:
      <input id="apiBase" type="text" style="width:360px" />
    </label>
    <button id="btnCheck">Check Server</button>
    <span id="srvStatus" class="status muted">not checked</span>
  </div>

  <div class="row">
    <label>Date:&nbsp;<input id="date" type="date" /></label>
    <div class="muted">Leave blank to auto-fill today.</div>
  </div>

  <div class="row" style="align-items:flex-start">
    <div style="flex:1 1 600px">
      <label>Notes</label>
      <textarea id="notes" placeholder="Alice: y - fixed login; t - write tests; b - waiting on @Bob for API.
Bob yesterday: reviewed PR; today: merge; blockers: flaky test"></textarea>
      <div class="bar">
        <button id="btnSample">Use Sample</button>
        <button class="primary" id="btnSummarize">AI Summarize</button> <button id="downloadMdBtn" type="button">Download .md</button> 
        <span id="busy" class="muted" style="display:none">working…</span>
      </div>
      <div class="muted">Notes autosave locally.</div>
    </div>
  </div>

  <div class="grid">
    <div>
      <h2 style="margin:0 0 8px">Markdown Output</h2>
      <div class="bar">
        <button id="btnCopy">Copy Markdown</button>
      </div>
      <div id="mdCard" class="card"><pre id="mdOut">(result will appear here)</pre></div>
    </div>

    <div>
      <h2 style="margin:0 0 8px">Usage &amp; Cost</h2>
      <div id="usageCard" class="card">
        <div id="usageOut" class="mono muted">—</div>
      </div>
      <div style="margin-top:8px" class="muted">
        Tip: You can also open with a query: <span class="mono">standup.html?api=http://localhost:3003</span>
      </div>
    </div>
  </div>

  <script>
    // --- Config (default to 3003, remember last) ---
    const qsApi = new URLSearchParams(location.search).get('api');
    const API_BASE_DEFAULT = 'http://localhost:3003';
    const savedBase = localStorage.getItem('api_base');
    const API_BASE = qsApi || savedBase || API_BASE_DEFAULT;

    // --- Helpers ---
    const $ = (id) => document.getElementById(id);
    const todayISO = () => new Date().toISOString().slice(0, 10);

    function setStatus(msg, ok = null) {
      const el = $('srvStatus');
      el.textContent = msg;
      el.classList.remove('ok', 'bad', 'muted');
      if (ok === true) el.classList.add('ok');
      else if (ok === false) el.classList.add('bad');
      else el.classList.add('muted');
    }
    function setBusy(isBusy) {
      $('btnSummarize').disabled = isBusy;
      $('btnCheck').disabled = isBusy;
      $('btnSample').disabled = isBusy;
      $('busy').style.display = isBusy ? '' : 'none';
    }
    function setMarkdown(text) { $('mdOut').textContent = text || ''; }
    function setUsage(model, usage, cost) {
      const u = usage || {};
      const input = u.input_tokens ?? u.prompt_tokens ?? 0;
      const output = u.output_tokens ?? u.completion_tokens ?? 0;
      const total = u.total_tokens ?? (input + output);
      const costStr = (cost != null) ? Number(cost).toFixed(6) : '0.000000';
      $('usageOut').textContent = `Model: ${model || 'n/a'} | input_tokens=${input}, output_tokens=${output}, total=${total} | est. $${costStr}`;
      $('usageOut').classList.remove('muted');
    }

    // --- Init ---
    (function init() {
      $('apiBase').value = API_BASE;
      $('date').placeholder = todayISO();
      const saved = localStorage.getItem('standup_notes_v1');
      if (saved) $('notes').value = saved;
      $('notes').addEventListener('input', () => {
        localStorage.setItem('standup_notes_v1', $('notes').value);
      });
      $('apiBase').addEventListener('change', e => {
        const base = (e.target.value || '').trim();
        if (base) localStorage.setItem('api_base', base);
      });
    })();

    // --- Actions ---
    $('btnSample').addEventListener('click', () => {
      const sample = [
        'Alice: y - fixed login; t - write tests; b - waiting on @Bob for API.',
        'Bob yesterday: reviewed PR; today: merge; blockers: flaky test',
        'Carol: y - refined user stories; t - sync with QA; b - none',
        'QA Team: y - executed 15 test cases (2 failed); t - rerun after hotfix; b - env instability',
      ].join('\n');
      $('notes').value = sample;
      localStorage.setItem('standup_notes_v1', sample);
    });

    $('btnCheck').addEventListener('click', async () => {
      setBusy(true);
      try {
        const base = $('apiBase').value.trim() || API_BASE_DEFAULT;

        const h = await fetch(`${base}/health`).then(r => r.json());
        const d = await fetch(`${base}/diag`).then(r => r.json());
        const tResp = await fetch(`${base}/diag/test`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
        const t = await tResp.json().catch(() => ({}));

        if (tResp.ok && t.ok) {
          setStatus(`OK • port=${h.port} • mode=${d.mode} • sdk=${d.sdkVersion} • hasKey=${d.hasKey} • model=${d.modelDefault}`, true);
          // remember working base
          localStorage.setItem('api_base', base);
        } else {
          setStatus(`Diag/test failed: ${t.detail || tResp.statusText}`, false);
        }
      } catch (e) {
        setStatus(`Server check error: ${e.message || e}`, false);
      } finally {
        setBusy(false);
      }
    });

    $('btnSummarize').addEventListener('click', async () => {
      setBusy(true);
      setMarkdown('');
      $('usageOut').textContent = '—';
      $('usageOut').classList.add('muted');

      try {
        const base = $('apiBase').value.trim() || API_BASE_DEFAULT;
        const date = $('date').value || todayISO();
        const notes = $('notes').value || '';

        const r = await fetch(`${base}/api/ai/standup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date, notes }),
        });

        const data = await r.json().catch(() => ({}));
        if (!r.ok || !data.ok) {
          const msg = data?.detail || r.statusText || 'Unknown error';
          setMarkdown(`Error: ${msg}`);
          setStatus('Summarize failed', false);
          return;
        }

        setMarkdown(data.markdown || '');
        setUsage(data.model, data.usage, data.estimated_cost_usd);
        setStatus('Summarize complete', true);
        // remember working base
        localStorage.setItem('api_base', base);
      } catch (e) {
        setMarkdown(`Error: ${e.message || e}`);
        setStatus('Summarize failed', false);
      } finally {
        setBusy(false);
      }
    });

    $('btnCopy').addEventListener('click', async () => {
      const text = $('mdOut').textContent || '';
      try {
        await navigator.clipboard.writeText(text);
        const old = $('btnCopy').textContent;
        $('btnCopy').textContent = 'Copied!';
        setTimeout(() => $('btnCopy').textContent = old, 900);
      } catch {
        const r = document.createRange();
        r.selectNodeContents($('mdOut'));
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(r);
        try { document.execCommand('copy'); } catch {}
        sel.removeAllRanges();
      }
    });
  </script>
<script src="js/export.js"></script>
<section id="historySection" style="border:1px solid #ddd;padding:10px;margin-top:12px;border-radius:8px;">
  <h3 style="margin-top:0;">History (<span id="historyCount">0</span>)</h3>
  <p id="historyEmpty" style="color:#666;margin:6px 0;">No saved summaries yet.</p>

  <div style="display:flex;gap:8px;margin-bottom:10px;">
    <button id="saveHistoryBtn" type="button">Save to History</button>
    <button id="clearHistoryBtn" type="button" title="Remove all saved summaries">Clear All</button>
  </div>

  <ul id="historyList" style="list-style:none;padding-left:0;margin:0;display:flex;flex-direction:column;gap:8px;"></ul>
</section>

<style>
  /* tiny styles to make list readable */
  .history-item { border:1px solid #eee; padding:8px; border-radius:6px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .history-header { display:flex; flex-direction:column; }
  .history-title { font-weight:600; }
  .history-meta { color:#777; font-size:12px; }
  .history-actions button { margin-left:6px; }
</style>

</body>
</html>
